<!DOCTYPE html>
<html>
<head>
    <title>Test Recommendations Endpoint</title>
</head>
<body>
    <h1>Test Spotify Recommendations Endpoint</h1>
    <button onclick="testRecommendations()">Test Recommendations</button>
    <pre id="output"></pre>

    <script>
        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('spotify_refresh_token');

            if (!refreshToken) {
                throw new Error('No refresh token available');
            }

            const response = await fetch('/api/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (!response.ok) {
                throw new Error(`Token refresh failed: ${response.status}`);
            }

            const data = await response.json();

            // Update localStorage
            localStorage.setItem('spotify_access_token', data.access_token);
            const expiresAt = Date.now() + (data.expires_in * 1000);
            localStorage.setItem('spotify_token_expires_at', expiresAt.toString());

            if (data.refresh_token) {
                localStorage.setItem('spotify_refresh_token', data.refresh_token);
            }

            return data.access_token;
        }

        async function getValidToken(output) {
            let token = localStorage.getItem('spotify_access_token');
            const expiresAt = localStorage.getItem('spotify_token_expires_at');

            if (!token) {
                output.textContent += 'ERROR: No access token found in localStorage.\n';
                output.textContent += 'Please log in to the app first at /\n';
                return null;
            }

            // Check if token is expired or expires in the next 5 minutes
            if (expiresAt && Date.now() >= (parseInt(expiresAt) - 5 * 60 * 1000)) {
                output.textContent += 'Token expired or expiring soon, refreshing...\n';
                try {
                    token = await refreshAccessToken();
                    output.textContent += 'Token refreshed successfully!\n\n';
                } catch (error) {
                    output.textContent += `ERROR: Failed to refresh token: ${error.message}\n`;
                    output.textContent += 'Please log in again at /\n';
                    return null;
                }
            } else {
                output.textContent += `Got token: ${token.substring(0, 20)}...\n\n`;
            }

            return token;
        }

        async function testRecommendations() {
            const output = document.getElementById('output');
            output.textContent = 'Testing...\n\n';

            try {
                // Get valid token (refreshes if expired)
                output.textContent += '1. Getting access token from localStorage...\n';
                const token = await getValidToken(output);

                if (!token) return;

                // Test a known track ID (Taylor Swift - Anti-Hero)
                const testTrackId = '0V3wPSX9ygBnCm8psDIegu';

                output.textContent += `2. Testing recommendations with track seed: ${testTrackId}\n`;

                // Test WITHOUT market parameter (like Python example)
                const url1 = `https://api.spotify.com/v1/recommendations?seed_tracks=${testTrackId}&limit=5`;
                output.textContent += `URL: ${url1}\n\n`;

                const response1 = await fetch(url1, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                output.textContent += `Response status: ${response1.status}\n`;

                if (response1.ok) {
                    const data = await response1.json();
                    output.textContent += `SUCCESS! Got ${data.tracks?.length || 0} recommendations\n\n`;
                    output.textContent += 'First 3 tracks:\n';
                    data.tracks?.slice(0, 3).forEach((track, i) => {
                        output.textContent += `${i + 1}. ${track.name} by ${track.artists[0].name}\n`;
                    });
                } else {
                    const errorText = await response1.text();
                    output.textContent += `FAILED: ${errorText}\n\n`;

                    // Try WITH market parameter
                    output.textContent += '3. Trying WITH market=US parameter...\n';
                    const url2 = `https://api.spotify.com/v1/recommendations?seed_tracks=${testTrackId}&limit=5&market=US`;
                    output.textContent += `URL: ${url2}\n\n`;

                    const response2 = await fetch(url2, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    output.textContent += `Response status: ${response2.status}\n`;

                    if (response2.ok) {
                        const data = await response2.json();
                        output.textContent += `SUCCESS with market! Got ${data.tracks?.length || 0} recommendations\n`;
                    } else {
                        const errorText2 = await response2.text();
                        output.textContent += `ALSO FAILED: ${errorText2}\n`;
                    }
                }

            } catch (error) {
                output.textContent += `Error: ${error.message}\n${error.stack}`;
            }
        }
    </script>
</body>
</html>
